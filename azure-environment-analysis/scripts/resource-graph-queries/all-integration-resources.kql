// All Integration Resources Query
// Purpose: Discover all Azure Integration Services resources in a subscription
// Usage: Run via Azure Resource Graph Explorer or Azure MCP Server
// 
// This query finds:
// - Logic Apps (Consumption and Standard)
// - Service Bus Namespaces
// - API Management instances
// - Function Apps
// - Key Vaults
// - Storage Accounts
// - App Configuration stores
// - Event Grid Topics
// - Event Hubs Namespaces

resources
| where type in~ (
    'microsoft.logic/workflows',                    // Logic Apps (Consumption)
    'microsoft.web/sites',                          // Logic Apps Standard + Function Apps
    'microsoft.servicebus/namespaces',              // Service Bus
    'microsoft.apimanagement/service',              // API Management
    'microsoft.keyvault/vaults',                    // Key Vault
    'microsoft.storage/storageaccounts',            // Storage Accounts
    'microsoft.appconfiguration/configurationstores', // App Configuration
    'microsoft.eventgrid/topics',                   // Event Grid Topics
    'microsoft.eventgrid/systemtopics',             // Event Grid System Topics
    'microsoft.eventhub/namespaces',                // Event Hubs
    'microsoft.relay/namespaces'                    // Azure Relay
)
// Filter web sites to Logic Apps Standard and Function Apps
| where type != 'microsoft.web/sites' 
    or (type == 'microsoft.web/sites' and 
        (kind contains 'functionapp' or kind contains 'workflowapp'))
| extend 
    resourceType = case(
        type == 'microsoft.logic/workflows', 'Logic App (Consumption)',
        type == 'microsoft.web/sites' and kind contains 'workflowapp', 'Logic App (Standard)',
        type == 'microsoft.web/sites' and kind contains 'functionapp', 'Function App',
        type == 'microsoft.servicebus/namespaces', 'Service Bus',
        type == 'microsoft.apimanagement/service', 'API Management',
        type == 'microsoft.keyvault/vaults', 'Key Vault',
        type == 'microsoft.storage/storageaccounts', 'Storage Account',
        type == 'microsoft.appconfiguration/configurationstores', 'App Configuration',
        type == 'microsoft.eventgrid/topics', 'Event Grid Topic',
        type == 'microsoft.eventgrid/systemtopics', 'Event Grid System Topic',
        type == 'microsoft.eventhub/namespaces', 'Event Hubs',
        type == 'microsoft.relay/namespaces', 'Azure Relay',
        'Other'
    ),
    skuName = coalesce(sku.name, properties.sku.name, 'N/A'),
    skuTier = coalesce(sku.tier, properties.sku.tier, 'N/A'),
    state = coalesce(
        properties.state,
        properties.provisioningState,
        'N/A'
    )
| project 
    name,
    resourceType,
    resourceGroup,
    location,
    skuName,
    skuTier,
    state,
    tags,
    subscriptionId,
    id
| order by resourceType asc, name asc

// Summary by type
// Uncomment below for summary view
// | summarize count() by resourceType
// | order by count_ desc
