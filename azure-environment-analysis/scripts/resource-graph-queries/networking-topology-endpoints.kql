// Networking Topology - Private Endpoints
// Purpose: Discover private endpoints for integration resources
// Usage: Run via Azure Resource Graph Explorer or Azure MCP Server
//
// Returns: Private endpoints with target resource and subnet information

resources
| where type == 'microsoft.network/privateendpoints'
| extend 
    targetResourceId = tostring(properties.privateLinkServiceConnections[0].properties.privateLinkServiceId),
    targetResourceType = tostring(split(properties.privateLinkServiceConnections[0].properties.privateLinkServiceId, '/')[6]),
    targetResourceName = tostring(split(properties.privateLinkServiceConnections[0].properties.privateLinkServiceId, '/')[8]),
    subnetId = tostring(properties.subnet.id),
    vnetName = tostring(split(properties.subnet.id, '/')[8]),
    subnetName = tostring(split(properties.subnet.id, '/')[10])
| where targetResourceType in~ (
    'microsoft.servicebus',
    'microsoft.keyvault',
    'microsoft.storage',
    'microsoft.web',
    'microsoft.eventgrid',
    'microsoft.eventhub',
    'microsoft.appconfiguration'
)
| project
    privateEndpointName = name,
    resourceGroup,
    location,
    targetResourceType,
    targetResourceName,
    vnetName,
    subnetName,
    tags
| order by targetResourceType asc, privateEndpointName asc
