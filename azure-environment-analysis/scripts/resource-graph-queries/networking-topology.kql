// Networking Topology Queries - Index File
// Purpose: Discover network configuration for integration resources
// Usage: Run individual query files via Azure Resource Graph Explorer or Azure MCP Server
//
// This file contains the main Private Endpoints query.
// For other network topology queries, use the split query files:
//
// Individual Query Files:
// - networking-topology-endpoints.kql      : Private Endpoints for integration
// - networking-topology-vnetintegration.kql: VNet Integration (Function/Logic Apps)
// - networking-topology-nsgs.kql           : NSGs associated with integration subnets
//
// Run each file separately as Azure Resource Graph doesn't support multi-statement queries.

// ============================================================================
// QUERY: Private Endpoints for Integration Resources
// ============================================================================
// Discovers private endpoints configured for integration services.
// Use to verify network isolation compliance.

resources
| where type == 'microsoft.network/privateendpoints'
| extend 
    targetResourceId = tostring(properties.privateLinkServiceConnections[0].properties.privateLinkServiceId),
    targetResourceType = tostring(split(properties.privateLinkServiceConnections[0].properties.privateLinkServiceId, '/')[6]),
    subnetId = tostring(properties.subnet.id),
    vnetName = tostring(split(properties.subnet.id, '/')[8]),
    subnetName = tostring(split(properties.subnet.id, '/')[10])
| where targetResourceType in~ (
    'microsoft.servicebus',
    'microsoft.keyvault',
    'microsoft.storage',
    'microsoft.web',
    'microsoft.eventgrid',
    'microsoft.eventhub',
    'microsoft.appconfiguration'
)
| project
    privateEndpointName = name,
    resourceGroup,
    location,
    targetResourceType,
    targetResourceId,
    vnetName,
    subnetName,
    tags
