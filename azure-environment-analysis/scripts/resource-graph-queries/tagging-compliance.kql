// Tagging Compliance Query
// Purpose: Analyze tag coverage across integration resources
// Usage: Run via Azure Resource Graph Explorer or Azure MCP Server
//
// Required tags checked (per SSOT naming-convention.md):
// - Owner
// - Environment
// - CostCenter
// - BusinessProcess
// - ManagedBy

resources
| where type in~ (
    'microsoft.logic/workflows',
    'microsoft.web/sites',
    'microsoft.servicebus/namespaces',
    'microsoft.apimanagement/service',
    'microsoft.keyvault/vaults',
    'microsoft.storage/storageaccounts',
    'microsoft.appconfiguration/configurationstores',
    'microsoft.eventgrid/topics',
    'microsoft.eventhub/namespaces'
)
// Filter web sites to Logic Apps Standard and Function Apps only
| where type != 'microsoft.web/sites' 
    or (type == 'microsoft.web/sites' and 
        (kind contains 'functionapp' or kind contains 'workflowapp'))
| extend
    hasOwnerTag = isnotnull(tags.Owner) or isnotnull(tags.owner),
    hasEnvironmentTag = isnotnull(tags.Environment) or isnotnull(tags.environment) or isnotnull(tags.env),
    hasCostCenterTag = isnotnull(tags.CostCenter) or isnotnull(tags.costCenter) or isnotnull(tags['cost-center']),
    hasBusinessProcessTag = isnotnull(tags.BusinessProcess) or isnotnull(tags.businessProcess) or isnotnull(tags.project) or isnotnull(tags.Project),
    hasManagedByTag = isnotnull(tags.ManagedBy) or isnotnull(tags.managedBy) or isnotnull(tags['managed-by']) or isnotnull(tags['created-by'])
| extend
    tagCount = toint(hasOwnerTag) + toint(hasEnvironmentTag) + toint(hasCostCenterTag) + toint(hasBusinessProcessTag) + toint(hasManagedByTag),
    allTagsPresent = hasOwnerTag and hasEnvironmentTag and hasCostCenterTag and hasBusinessProcessTag and hasManagedByTag
| project
    name,
    type,
    resourceGroup,
    hasOwnerTag,
    hasEnvironmentTag,
    hasCostCenterTag,
    hasBusinessProcessTag,
    hasManagedByTag,
    tagCount,
    allTagsPresent,
    tags
| order by tagCount asc, name asc

// Summary Query (uncomment to use)
// | summarize
//     totalResources = count(),
//     withAllTags = countif(allTagsPresent),
//     withOwner = countif(hasOwnerTag),
//     withEnvironment = countif(hasEnvironmentTag),
//     withCostCenter = countif(hasCostCenterTag),
//     withBusinessProcess = countif(hasBusinessProcessTag),
//     withManagedBy = countif(hasManagedByTag)
//     by type
// | extend
//     allTagsPercent = round(100.0 * withAllTags / totalResources, 1),
//     ownerPercent = round(100.0 * withOwner / totalResources, 1),
//     environmentPercent = round(100.0 * withEnvironment / totalResources, 1)
// | order by type asc

// Tag Value Consistency Check (uncomment to use)
// resources
// | where type in~ ('microsoft.logic/workflows', 'microsoft.servicebus/namespaces')
// | where isnotnull(tags.environment)
// | summarize count() by tostring(tags.environment)
// | order by count_ desc
