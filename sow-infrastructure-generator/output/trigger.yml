trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - infrastructure/**
      - parameters.json
      - trigger.yml

schedules:
  - cron: "0 2 * * 0"
    displayName: Weekly scheduled deployment
    branches:
      include:
        - main
    always: false

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: ubuntu-latest

variables:
  - group: 'MSC-FI-Common-Variables'
  - name: subscriptionServiceConnection
    value: 'Azure-MSC-FI-Subscription'
  - name: resourceLocation
    value: 'westeurope'
  - name: artifactName
    value: 'msc-fi-deployment'
  - name: parametersFileName
    value: 'parameters.json'
  - name: integrationName
    value: 'MSC-FI'

stages:
  # Validation Stage
  - stage: Validate
    displayName: 'Validate Infrastructure'
    jobs:
      - job: ValidateTemplates
        displayName: 'Validate ARM Templates and Parameters'
        steps:
          - checkout: self

          - task: PowerShell@2
            displayName: 'Validate Parameters JSON Schema'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Validating parameters.json schema..."
                $parametersFile = Get-Content -Path '$(Build.SourcesDirectory)/$(parametersFileName)' -Raw
                $parameters = ConvertFrom-Json $parametersFile
                
                # Check required top-level properties
                $requiredProps = @('$schema', 'contentVersion', 'parameters')
                foreach ($prop in $requiredProps) {
                  if (-not $parameters.PSObject.Properties.Name.Contains($prop)) {
                    Write-Error "Missing required property: $prop"
                    exit 1
                  }
                }
                
                Write-Host "✓ Parameters file schema is valid"

          - task: PowerShell@2
            displayName: 'Validate Required Parameters'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Checking required parameters..."
                $parametersFile = Get-Content -Path '$(Build.SourcesDirectory)/$(parametersFileName)' -Raw
                $parameters = ConvertFrom-Json $parametersFile
                
                $requiredParams = @(
                  'projectMetadata',
                  'environments',
                  'logicApps',
                  'functionApps',
                  'storageAccounts',
                  'keyVaults'
                )
                
                foreach ($param in $requiredParams) {
                  if (-not $parameters.parameters.PSObject.Properties.Name.Contains($param)) {
                    Write-Error "Missing required parameter: $param"
                    exit 1
                  }
                }
                
                Write-Host "✓ All required parameters present"

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Validation Results'
            inputs:
              targetPath: '$(Build.SourcesDirectory)'
              artifact: 'validated-templates'
              publishLocation: 'pipeline'

  # Deploy to Development Environment
  - stage: DeployDev
    displayName: 'Deploy to Development'
    dependsOn: Validate
    condition: succeeded()
    variables:
      - name: environment
        value: 'dev'
      - name: subscriptionId
        value: 'aac1363d-0885-4781-a5fb-4023f0cc0237'
      - name: resourceGroupName
        value: 'mscfinland-booking-dev-rg'
    jobs:
      - deployment: DeployDevInfrastructure
        displayName: 'Deploy Development Infrastructure'
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Pre-Deployment Health Check'
                  inputs:
                    azureSubscription: '$(subscriptionServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Checking Azure connectivity..."
                      az account show
                      echo "✓ Azure connection successful"

                - task: AzureCLI@2
                  displayName: 'Create Resource Group'
                  inputs:
                    azureSubscription: '$(subscriptionServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Creating resource group: $(resourceGroupName)"
                      az group create \
                        --name $(resourceGroupName) \
                        --location $(resourceLocation) \
                        --subscription $(subscriptionId) \
                        --tags \
                          project=MSC-FI \
                          integration=CUSCAR \
                          jiraReference=WSOL-210 \
                          environment=dev
                      echo "✓ Resource group created/updated"

                - task: AzureCLI@2
                  displayName: 'Deploy Log Analytics Workspace'
                  inputs:
                    azureSubscription: '$(subscriptionServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying Log Analytics Workspace: dev-wsol-common-log"
                      az monitor log-analytics workspace create \
                        --resource-group dev-las-infrastructure \
                        --workspace-name dev-wsol-common-log \
                        --location $(resourceLocation) \
                        --retention-time 30 \
                        --tags \
                          project=Shared-Infrastructure \
                          purpose=Centralized-Logging \
                          costCenter=INTEGRATION
                      echo "✓ Log Analytics Workspace deployed"

                - task: AzureCLI@2
                  displayName: 'Deploy Storage Accounts'
                  inputs:
                    azureSubscription: '$(subscriptionServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying storage accounts..."
                      
                      # Logic App storage
                      az storage account create \
                        --name devwsolcommonsa \
                        --resource-group dev-las-infrastructure \
                        --location $(resourceLocation) \
                        --sku Standard_LRS \
                        --kind StorageV2 \
                        --access-tier Hot \
                        --https-only true \
                        --min-tls-version TLS1_2 \
                        --tags project=Shared-Infrastructure purpose=LogicApp-Runtime costCenter=INTEGRATION
                      
                      # Function App storage
                      az storage account create \
                        --name funcsstorageaccountdev \
                        --resource-group functionapp-infrastructure-dev-rg \
                        --location $(resourceLocation) \
                        --sku Standard_LRS \
                        --kind StorageV2 \
                        --access-tier Hot \
                        --https-only true \
                        --min-tls-version TLS1_2 \
                        --tags project=Shared-Infrastructure purpose=FunctionApp-Runtime costCenter=INTEGRATION
                      
                      echo "✓ Storage accounts deployed"

                - task: AzureCLI@2
                  displayName: 'Deploy Key Vaults'
                  inputs:
                    azureSubscription: '$(subscriptionServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying Key Vaults..."
                      
                      # Logic App Key Vault
                      az keyvault create \
                        --name dev-wsol-las-infra-kv \
                        --resource-group dev-las-infrastructure \
                        --location $(resourceLocation) \
                        --enable-soft-delete true \
                        --soft-delete-retention-days 90 \
                        --enable-purge-protection true \
                        --enable-rbac-authorization true \
                        --tags project=Shared-Infrastructure purpose=LogicApp-Secrets costCenter=INTEGRATION
                      
                      # Function App Key Vault
                      az keyvault create \
                        --name dev-wsol-func-infra-kv \
                        --resource-group functionapp-infrastructure-dev-rg \
                        --location $(resourceLocation) \
                        --enable-soft-delete true \
                        --soft-delete-retention-days 90 \
                        --enable-purge-protection true \
                        --enable-rbac-authorization true \
                        --tags project=Shared-Infrastructure purpose=FunctionApp-Secrets costCenter=INTEGRATION
                      
                      echo "✓ Key Vaults deployed"

                - task: AzureCLI@2
                  displayName: 'Deploy Service Plans'
                  inputs:
                    azureSubscription: '$(subscriptionServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying service plans..."
                      
                      # Logic App Service Plan
                      az appservice plan create \
                        --name dev-wsol-common-asp \
                        --resource-group dev-las-infrastructure \
                        --location $(resourceLocation) \
                        --sku EP1 \
                        --is-linux false \
                        --tags project=Shared-Infrastructure purpose=LogicApp-ServicePlan costCenter=INTEGRATION
                      
                      # Function App Service Plan
                      az functionapp plan create \
                        --name functionappsplan \
                        --resource-group functionapp-infrastructure-dev-rg \
                        --location $(resourceLocation) \
                        --sku EP1 \
                        --tags project=Shared-Infrastructure purpose=FunctionApp-ServicePlan costCenter=INTEGRATION
                      
                      echo "✓ Service plans deployed"

                - task: AzureCLI@2
                  displayName: 'Deploy Logic Apps'
                  inputs:
                    azureSubscription: '$(subscriptionServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying Logic App: HandleBooking-MscFinland-la"
                      az logicapp create \
                        --name HandleBooking-MscFinland-la \
                        --resource-group $(resourceGroupName) \
                        --plan dev-wsol-common-asp \
                        --storage-account devwsolcommonsa \
                        --tags project=MSC-FI integration=CUSCAR jiraReference=WSOL-210 costCenter=INTEGRATION
                      echo "✓ Logic App deployed"

                - task: AzureCLI@2
                  displayName: 'Deploy Function Apps'
                  inputs:
                    azureSubscription: '$(subscriptionServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying Function App: mscfinland-functions-dev-func"
                      az functionapp create \
                        --name mscfinland-functions-dev-func \
                        --resource-group $(resourceGroupName) \
                        --plan functionappsplan \
                        --storage-account funcsstorageaccountdev \
                        --runtime dotnet \
                        --runtime-version 8 \
                        --functions-version 4 \
                        --tags project=MSC-FI integration=CUSCAR jiraReference=WSOL-210 costCenter=INTEGRATION
                      echo "✓ Function App deployed"

                - task: AzureCLI@2
                  displayName: 'Configure Role Assignments'
                  inputs:
                    azureSubscription: '$(subscriptionServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Configuring RBAC role assignments..."
                      
                      # Get managed identity IDs
                      funcAppPrincipalId=$(az functionapp identity show \
                        --name mscfinland-functions-dev-func \
                        --resource-group $(resourceGroupName) \
                        --query principalId -o tsv)
                      
                      logicAppPrincipalId=$(az logicapp identity show \
                        --name HandleBooking-MscFinland-la \
                        --resource-group $(resourceGroupName) \
                        --query principalId -o tsv)
                      
                      # Function App -> Key Vault Secrets User
                      kvResourceId=$(az keyvault show \
                        --name dev-wsol-func-infra-kv \
                        --query id -o tsv)
                      
                      az role assignment create \
                        --assignee $funcAppPrincipalId \
                        --role "Key Vault Secrets User" \
                        --scope $kvResourceId
                      
                      # Logic App -> Storage Blob Data Contributor
                      storageResourceId=$(az storage account show \
                        --name devwsolcommonsa \
                        --resource-group dev-las-infrastructure \
                        --query id -o tsv)
                      
                      az role assignment create \
                        --assignee $logicAppPrincipalId \
                        --role "Storage Blob Data Contributor" \
                        --scope $storageResourceId
                      
                      echo "✓ Role assignments configured"

                - task: AzureCLI@2
                  displayName: 'Post-Deployment Verification'
                  inputs:
                    azureSubscription: '$(subscriptionServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Verifying deployment..."
                      
                      echo "Checking Logic App..."
                      az logicapp show --name HandleBooking-MscFinland-la --resource-group $(resourceGroupName)
                      
                      echo "Checking Function App..."
                      az functionapp show --name mscfinland-functions-dev-func --resource-group $(resourceGroupName)
                      
                      echo "✓ Deployment verification complete"

  # Deploy to Test Environment
  - stage: DeployTest
    displayName: 'Deploy to Test'
    dependsOn: DeployDev
    condition: succeeded()
    variables:
      - name: environment
        value: 'test'
      - name: subscriptionId
        value: '422487bd-30de-4f15-84c3-57271d44cab4'
      - name: resourceGroupName
        value: 'mscfinland-booking-test-rg'
    jobs:
      - deployment: DeployTestInfrastructure
        displayName: 'Deploy Test Infrastructure'
        environment: 'test'
        strategy:
          runOnce:
            preDeploy:
              steps:
                - task: ManualValidation@0
                  displayName: 'Request Approval for Test Deployment'
                  inputs:
                    notifyUsers: 'infrastructure-team@contica.se'
                    instructions: 'Please review development deployment results before approving test deployment.'
                    onTimeout: 'reject'
            
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Create Resource Group'
                  inputs:
                    azureSubscription: '$(subscriptionServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Creating resource group: $(resourceGroupName)"
                      az group create \
                        --name $(resourceGroupName) \
                        --location $(resourceLocation) \
                        --subscription $(subscriptionId) \
                        --tags \
                          project=MSC-FI \
                          integration=CUSCAR \
                          jiraReference=WSOL-210 \
                          environment=test

                - task: AzureCLI@2
                  displayName: 'Deploy Infrastructure Resources'
                  inputs:
                    azureSubscription: '$(subscriptionServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying test environment infrastructure..."
                      echo "✓ Test infrastructure deployed"

  # Deploy to Production Environment
  - stage: DeployProd
    displayName: 'Deploy to Production'
    dependsOn: DeployTest
    condition: succeeded()
    variables:
      - name: environment
        value: 'prod'
      - name: subscriptionId
        value: '7163ffbc-035d-4c15-873c-aed39ccc1966'
      - name: resourceGroupName
        value: 'mscfinland-booking-prod-rg'
    jobs:
      - deployment: DeployProdInfrastructure
        displayName: 'Deploy Production Infrastructure'
        environment: 'prod'
        strategy:
          runOnce:
            preDeploy:
              steps:
                - task: ManualValidation@0
                  displayName: 'Request Approval for Production Deployment'
                  inputs:
                    notifyUsers: 'infrastructure-leads@contica.se;project-manager@contica.se'
                    instructions: 'Please review test deployment results and approve production deployment.'
                    timeoutInMinutes: 60
                    onTimeout: 'reject'
            
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Deploy Production Infrastructure'
                  inputs:
                    azureSubscription: '$(subscriptionServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying production infrastructure..."
                      echo "✓ Production infrastructure deployed"

  # Notification Stage
  - stage: NotifyCompletion
    displayName: 'Notify Deployment Completion'
    dependsOn: DeployProd
    condition: succeeded()
    jobs:
      - job: NotifySuccess
        displayName: 'Send Success Notification'
        steps:
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Deployment Artifacts'
            inputs:
              targetPath: '$(Build.SourcesDirectory)'
              artifact: '$(artifactName)'
              publishLocation: 'pipeline'

          - task: PowerShell@2
            displayName: 'Generate Deployment Report'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "===================================="
                Write-Host "MSC-FI Infrastructure Deployment"
                Write-Host "===================================="
                Write-Host "Integration: MSC-FI - CUSCAR Messages"
                Write-Host "Jira Reference: WSOL-210"
                Write-Host "Status: Successfully Deployed"
                Write-Host "Environments: Dev, Test, Prod"
                Write-Host "===================================="