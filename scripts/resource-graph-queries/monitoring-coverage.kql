// Monitoring Coverage Queries - Index File
// Purpose: Identify resources missing diagnostic settings and monitoring
// Usage: Run individual query files via Azure Resource Graph Explorer or Azure MCP Server
//
// This file contains the main resource inventory query.
// For specific monitoring checks, use the split query files:
//
// Individual Query Files:
// - monitoring-coverage-resources.kql   : All integration resources inventory
// - monitoring-coverage-workspaces.kql  : Log Analytics workspace list
// - monitoring-coverage-appinsights.kql : Application Insights configuration
// - monitoring-coverage-alerts.kql      : Alert rules inventory
// - monitoring-coverage-summary.kql     : Resource count summary
//
// Note: Diagnostic settings are sub-resources and require separate API calls
// (not directly queryable via Resource Graph).
// Run each file separately as Azure Resource Graph doesn't support multi-statement queries.

// ============================================================================
// QUERY: Integration Resources Inventory (for monitoring analysis)
// ============================================================================
// Lists all integration resources that should have monitoring configured.
// Use this as a baseline for checking diagnostic settings coverage.

resources
| where type in~ (
    'microsoft.logic/workflows',
    'microsoft.web/sites',
    'microsoft.servicebus/namespaces',
    'microsoft.apimanagement/service',
    'microsoft.keyvault/vaults',
    'microsoft.storage/storageaccounts',
    'microsoft.eventgrid/topics',
    'microsoft.eventhub/namespaces'
)
| where type != 'microsoft.web/sites' 
    or (type == 'microsoft.web/sites' and 
        (kind contains 'functionapp' or kind contains 'workflowapp'))
| extend resourceType = case(
    type == 'microsoft.logic/workflows', 'Logic App',
    type == 'microsoft.web/sites' and kind contains 'workflowapp', 'Logic App Standard',
    type == 'microsoft.web/sites' and kind contains 'functionapp', 'Function App',
    type == 'microsoft.servicebus/namespaces', 'Service Bus',
    type == 'microsoft.apimanagement/service', 'API Management',
    type == 'microsoft.keyvault/vaults', 'Key Vault',
    type == 'microsoft.storage/storageaccounts', 'Storage Account',
    type == 'microsoft.eventgrid/topics', 'Event Grid',
    type == 'microsoft.eventhub/namespaces', 'Event Hubs',
    'Other'
)
| project
    name,
    resourceType,
    resourceGroup,
    location,
    id,
    subscriptionId
| order by resourceType asc, name asc
